<!DOCTYPE html>
<html>
<head>
<title>Pathfinder's Journey - Card Game</title>
<style>
  /* Basic styling for card game layout */
  body {
    font-family: 'Inter', sans-serif;
    line-height: 1.6;
    padding: 20px;
    background-color: #e0f2f7; /* Lighter blue background */
    color: #1a202c; /* Darker text */
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }
  #gameArea {
    background-color: #ffffff;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 800px; /* Slightly wider for card layout */
    margin-top: 20px;
  }
  h1, h2, h3, h4 {
    color: #004d40; /* Dark teal headings */
    border-bottom: 1px solid #b2dfdb; /* Light teal border */
    padding-bottom: 6px;
    margin-bottom: 15px;
  }
  h1 { font-size: 1.8em; text-align: center; }
  h2 { font-size: 1.4em; }
  h3 { font-size: 1.2em; }
  h4 { font-size: 1.0em; margin-bottom: 10px; border-bottom: none;}

  /* Button Styling */
  button {
    padding: 12px 20px;
    margin: 8px 5px;
    background-color: #00796b; /* Teal */
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1em;
    font-weight: 500;
    transition: background-color 0.2s ease, transform 0.1s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  button:disabled {
    background-color: #bdbdbd; /* Gray when disabled */
    cursor: default;
    box-shadow: none;
    transform: none;
  }
  button:hover:enabled {
    background-color: #004d40; /* Darker teal */
    transform: translateY(-1px);
  }
   button:active:enabled {
      transform: translateY(0px);
  }

  #characterSelection button {
    background-color: #0288d1; /* Blue for character selection */
  }
  #characterSelection button:hover:enabled {
    background-color: #01579b; /* Darker blue */
  }
  #restartBtn {
      background-color: #ffa000; /* Amber for restart */
  }
   #restartBtn:hover:enabled {
      background-color: #ff6f00; /* Darker amber */
  }

  /* Layout Areas */
  .game-layout { display: flex; flex-wrap: wrap; gap: 20px; }
  .player-area { flex-basis: 250px; flex-grow: 1; }
  .game-state-area { flex-basis: 150px; flex-grow: 1; }
  .active-card-area { flex-basis: 100%; } /* Full width for active card */
  .log-area { flex-basis: 100%; } /* Full width for log */

  /* Card Styling */
  .card {
      border: 1px solid #b0bec5; /* Blue-gray border */
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #eceff1; /* Light blue-gray background */
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      min-height: 100px; /* Minimum height for cards */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
   .card.active-landscape {
       border-color: #004d40;
       background-color: #e0f2f1; /* Lighter teal background */
       transform: scale(1.02); /* Slightly larger active card */
       box-shadow: 0 4px 10px rgba(0,0,0,0.15);
   }
  .card h4 { margin-top: 0; color: #00695c; } /* Teal card titles */
  .card p { margin: 5px 0; font-size: 0.9em; }
  .card strong { color: #37474f; } /* Dark blue-gray for labels */

  /* Deck Representation */
  .deck {
      border: 2px dashed #78909c; /* Dashed border for deck */
      border-radius: 10px;
      padding: 20px 15px;
      text-align: center;
      background-color: #cfd8dc; /* Lighter gray */
      color: #455a64;
      font-weight: bold;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
  }
  .deck .card-count { font-size: 1.5em; display: block; }

  /* Resources List */
  .resources li {
    display: inline-block;
    background-color: #90a4ae; /* Blue-gray background */
    color: #ffffff; /* White text */
    padding: 4px 10px;
    margin: 3px;
    border-radius: 12px; /* Pill shape */
    font-size: 0.85em;
    font-weight: 500;
  }
  .resources { padding-left: 0; list-style: none; margin-top: 5px; }

  /* Log Area */
  #log {
    margin-top: 20px;
    border-top: 1px solid #b0bec5;
    padding-top: 15px;
    max-height: 250px;
    overflow-y: auto;
    font-size: 0.9em;
    color: #37474f;
    background-color: #f5f5f5; /* Light gray */
    border-radius: 8px;
    padding: 15px;
  }
   #log p { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #cfd8dc; }
   #log p:last-child { border-bottom: none; }

  /* Message Styling */
  .error { color: #d32f2f; font-weight: 600; } /* Red */
  .success { color: #388e3c; font-weight: 600; } /* Green */
  .info { color: #37474f; } /* Standard info color */

</style>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>

<div id="gameArea">
  <h1>Pathfinder's Journey - Card Game</h1>

  <div id="setup">
    <p>Embark on a journey by drawing cards representing the landscapes and challenges ahead.</p>
    <button id="startGameBtn">Start New Game</button>
  </div>

  <div id="characterSelection" style="display: none;">
    <h2>Choose Your Character</h2>
    </div>

  <div id="gameplay" style="display: none;">
      <div class="game-layout">
          <div class="player-area">
              <h3>Character</h3>
              <div id="characterCard" class="card character-info">
                  <h4 id="charName">Character Name</h4>
                  <p><strong>Health:</strong> <span id="charHealth">0</span> / <span id="maxHealth">0</span></p>
                  <p><strong>Stats:</strong> P:<span id="statP">0</span> M:<span id="statM">0</span> Sp:<span id="statSp">0</span> So:<span id="statSo">0</span></p>
                  <p><strong>Resources (<span id="resourceCount">0</span>/<span id="resourceCap"></span>):</strong></p>
                  <ul id="resourceList" class="resources"></ul>
              </div>
               <button id="drawCardBtn" title="Draw the next landscape card from the deck.">Draw Landscape Card</button>
               <button id="restartBtn" style="display: none;" title="Start the game over.">Restart Game</button>
          </div>

          <div class="game-state-area">
              <h3>Game State</h3>
              <div id="journeyDeck" class="deck" title="Landscape cards remaining in the deck.">
                  Journey Deck<span class="card-count" id="deckCount">0</span>
              </div>
              <div id="seasonCard" class="card season-info">
                  <h4>Season</h4>
                  <p><strong id="seasonName">Season Name</strong></p>
                  <p id="seasonEffect">Effect description...</p>
                  <p id="seasonBenefit">Benefit description...</p>
              </div>
          </div>

          <div class="active-card-area">
              <h3>Active Landscape</h3>
              <div id="activeLandscapeCard" class="card">
                  <p>Draw a card to begin your journey...</p>
                  </div>
          </div>

           <div class="log-area">
                <h3>Log</h3>
                <div id="log">
                    <div id="logMessages"></div>
                </div>
           </div>
      </div>
  </div>

</div>

<script>
  // --- DATA MODELS (Simplified for Card Game) ---
   const characters = [
    { id: 'giant_beastfriend', name: 'Giant Beastfriend', health: 7, resourceCapacity: 8, stats: { physical: 3, mental: 2, spiritual: 3, social: 1 }, startingItems: ['horse_hair', 'standing_stone_chips'] },
    { id: 'hedge_witch', name: 'Hedge Witch/Warlock', health: 5, resourceCapacity: 7, stats: { physical: 1, mental: 3, spiritual: 4, social: 1 }, startingItems: ['silver_mistletoe', 'sacred_water'] },
    { id: 'iron_crafter', name: 'Iron Crafter', health: 6, resourceCapacity: 6, stats: { physical: 3, mental: 3, spiritual: 1, social: 2 }, startingItems: ['bog_iron', 'forge_cinders'] },
    { id: 'village_elder', name: 'Village Elder', health: 5, resourceCapacity: 5, stats: { physical: 1, mental: 4, spiritual: 3, social: 3 }, startingItems: ['ogham_sticks', 'barrow_dust'] }
  ];

   const landscapes = [
    { id: 'ancient_stone_circle', name: 'Ancient Stone Circle', challenge: 'Spectral Guardians', challengeType: 'mental', difficulty: 5, description: 'Towering stones hum with ancient power.', availableResources: ['standing_stone_chips', 'barrow_dust'], healing: 0 },
    { id: 'misty_barrow_downs', name: 'Misty Barrow Downs', challenge: 'Ancestral Spirits', challengeType: 'spiritual', difficulty: 6, description: 'Rolling hills shrouded in mist.', availableResources: ['barrow_dust', 'ogham_sticks'], healing: 0 },
    { id: 'sacred_oak_grove', name: 'Sacred Oak Grove', challenge: 'Wild Beasts', challengeType: 'physical', difficulty: 4, description: 'An ancient forest watched over by oaks.', availableResources: ['rowan_wood', 'oak_galls'], healing: 0 },
    { id: 'thatched_village', name: 'Thatched Village', challenge: 'Suspicious Elders', challengeType: 'social', difficulty: 5, description: 'A small community, wary of outsiders.', availableResources: ['woven_reeds', 'horse_hair'], healing: 0 },
    { id: 'iron_forge_dell', name: 'Iron Forge Dell', challenge: 'Molten Trials', challengeType: 'physical', difficulty: 7, description: 'Heat and sparks fly from a hidden forge.', availableResources: ['bog_iron', 'forge_cinders'], healing: 0 },
    { id: 'moonlit_loch', name: 'Moonlit Loch', challenge: 'Water Spirits', challengeType: 'spiritual', difficulty: 5, description: 'Still waters reflect the moon.', availableResources: ['sacred_water', 'woven_reeds'], healing: 2 },
    { id: 'menhir_path', name: 'Menhir Path', challenge: 'Stone Sentinels', challengeType: 'perception', difficulty: 6, description: 'A path marked by weathered stones.', availableResources: ['standing_stone_chips', 'ogham_sticks'], healing: 0 },
    { id: 'faerie_knoll', name: 'Faerie Knoll', challenge: 'Trickster Beings', challengeType: 'cunning', difficulty: 7, description: 'Where the veil between worlds is thin.', availableResources: ['silver_mistletoe', 'amber_shards'], healing: 0 },
    // Add more landscapes if needed, ensure 'availableResources' is an array
    { id: 'whispering_heath', name: 'Whispering Heath', challenge: 'Deceptive Paths', challengeType: 'navigation', difficulty: 5, description: 'Wind whispers secrets across the heath.', availableResources: ['woven_reeds', 'rowan_wood'], healing: 0 },
    { id: 'blackthorn_maze', name: 'Blackthorn Maze', challenge: 'Thorny Barriers', challengeType: 'endurance', difficulty: 6, description: 'A dense thicket that tears.', availableResources: ['rowan_wood', 'bog_iron'], healing: 0 },
    { id: 'boggy_lowlands', name: 'Boggy Lowlands', challenge: 'Sinking Ground', challengeType: 'agility', difficulty: 5, description: 'Treacherous ground.', availableResources: ['bog_iron', 'woven_reeds'], healing: 0 },
    { id: 'druids_sanctuary', name: 'Druid\'s Sanctuary', challenge: 'Wisdom Trial', challengeType: 'knowledge', difficulty: 8, description: 'A hidden place of learning.', availableResources: ['silver_mistletoe', 'oak_galls'], healing: 2 },
  ];

   const seasons = [
    { id: 'samhain', name: 'Samhain', description: 'Winter Beginning.', effect: 'Spiritual challenges +2 diff', benefit: 'None', modifiers: { spiritual: 2 } },
    { id: 'wintersDepth', name: "Winter's Depth", description: 'Coldest winter.', effect: 'Physical challenges +2 diff', benefit: 'Mental challenges -1 diff', modifiers: { physical: 2, mental: -1 } },
    { id: 'imbolc', name: 'Imbolc', description: 'Spring Stirrings.', effect: 'Healing +1 effective', benefit: 'All challenges -1 diff', modifiers: { all: -1 } },
    { id: 'beltane', name: 'Beltane', description: 'Summer Beginning.', effect: 'Crafting +1 use (Not used)', benefit: 'Max Health +1', modifiers: {} },
    { id: 'lughnasadh', name: 'Lughnasadh', description: 'Harvest Beginning.', effect: 'Collect +1 Resource', benefit: 'Healing x2 effective', modifiers: { social: -1 } }
  ];

  // --- GAME STATE ---
  let gameState = {
    character: null,
    currentHealth: 0,
    maxHealth: 0,
    resources: [],
    resourceCapacity: 0,
    deck: [], // Array of landscape card objects
    activeLandscape: null,
    discardPile: [],
    currentSeasonIndex: 0,
    turn: 0,
    seasonTurnsDuration: 3, // How many turns a season lasts
    gameOver: false,
    gameStarted: false
  };

  // --- DOM Elements ---
  const setupDiv = document.getElementById('setup');
  const characterSelectionDiv = document.getElementById('characterSelection');
  const gameplayDiv = document.getElementById('gameplay');
  const startGameBtn = document.getElementById('startGameBtn');
  const drawCardBtn = document.getElementById('drawCardBtn');
  const restartBtn = document.getElementById('restartBtn');

  const characterCardDiv = document.getElementById('characterCard');
  const charNameH4 = document.getElementById('charName');
  const charHealthSpan = document.getElementById('charHealth');
  const maxHealthSpan = document.getElementById('maxHealth');
  const statPSpan = document.getElementById('statP');
  const statMSpan = document.getElementById('statM');
  const statSpSpan = document.getElementById('statSp');
  const statSoSpan = document.getElementById('statSo');
  const resourceListUl = document.getElementById('resourceList');
  const resourceCountSpan = document.getElementById('resourceCount');
  const resourceCapSpan = document.getElementById('resourceCap');

  const journeyDeckDiv = document.getElementById('journeyDeck');
  const deckCountSpan = document.getElementById('deckCount');
  const seasonCardDiv = document.getElementById('seasonCard');
  const seasonNameStrong = document.getElementById('seasonName');
  const seasonEffectP = document.getElementById('seasonEffect');
  const seasonBenefitP = document.getElementById('seasonBenefit');

  const activeLandscapeCardDiv = document.getElementById('activeLandscapeCard');
  const logMessagesDiv = document.getElementById('logMessages');

  // --- UTILITY FUNCTIONS ---
  function logMessage(message, type = 'info') {
    const p = document.createElement('p');
    p.textContent = message;
    p.classList.add(type);
    logMessagesDiv.prepend(p);
  }

  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  // --- UI UPDATE FUNCTIONS ---

  function updateCharacterUI() {
    if (!gameState.character) return;
    const char = gameState.character;
    charNameH4.textContent = char.name;
    charHealthSpan.textContent = gameState.currentHealth;
    maxHealthSpan.textContent = gameState.maxHealth;
    statPSpan.textContent = char.stats.physical;
    statMSpan.textContent = char.stats.mental;
    statSpSpan.textContent = char.stats.spiritual;
    statSoSpan.textContent = char.stats.social;
    resourceCapSpan.textContent = gameState.resourceCapacity;
    resourceCountSpan.textContent = gameState.resources.length;

    resourceListUl.innerHTML = '';
    gameState.resources.forEach(res => {
      const li = document.createElement('li');
      li.textContent = res;
      resourceListUl.appendChild(li);
    });

     // Update health display color
    const healthPercentage = (gameState.currentHealth / gameState.maxHealth) * 100;
    charHealthSpan.style.color = healthPercentage <= 25 ? '#d32f2f' : healthPercentage <= 50 ? '#ffa000' : '#388e3c';
    charHealthSpan.style.fontWeight = healthPercentage <= 50 ? 'bold' : 'normal';
  }

  function updateSeasonUI() {
      const season = seasons[gameState.currentSeasonIndex];
      seasonNameStrong.textContent = `${season.name} (Turn ${gameState.turn % gameState.seasonTurnsDuration + 1}/${gameState.seasonTurnsDuration})`;
      seasonEffectP.textContent = `Effect: ${season.effect || 'None'}`;
      seasonBenefitP.textContent = `Benefit: ${season.benefit || 'None'}`;
  }

  function updateDeckUI() {
      deckCountSpan.textContent = gameState.deck.length;
      journeyDeckDiv.style.display = gameState.deck.length > 0 ? 'flex' : 'none'; // Hide deck when empty
  }

 function updateActiveLandscapeUI() {
    activeLandscapeCardDiv.innerHTML = ''; // Clear previous card
    activeLandscapeCardDiv.classList.remove('active-landscape');

    if (gameState.activeLandscape) {
        const landscape = gameState.activeLandscape;
        const difficulty = getChallengeDifficulty(landscape); // Calculate effective difficulty
        const cardHTML = `
            <h4>${landscape.name}</h4>
            <p><em>${landscape.description}</em></p>
            <p><strong>Challenge:</strong> ${landscape.challenge} (${landscape.challengeType})</p>
            <p><strong>Difficulty:</strong> ${difficulty} (Base: ${landscape.difficulty})</p>
            <p><strong>Potential Resources:</strong> ${landscape.availableResources.join(', ') || 'None'}</p>
            ${landscape.healing ? `<p><strong>Special:</strong> Offers healing (+${getHealingAmount(landscape)} health).</p>` : ''}
        `;
        activeLandscapeCardDiv.innerHTML = cardHTML;
        activeLandscapeCardDiv.classList.add('active-landscape');
    } else if (!gameState.gameStarted) {
         activeLandscapeCardDiv.innerHTML = '<p>Choose your character to begin.</p>';
    } else if (gameState.deck.length === 0 && !gameState.gameOver) {
        activeLandscapeCardDiv.innerHTML = '<p>The Journey Deck is empty!</p>';
        // Potentially trigger win condition here or after next action
    } else if (!gameState.gameOver){
        activeLandscapeCardDiv.innerHTML = '<p>Draw a Landscape card to continue...</p>';
    } else {
        // Game over state
         activeLandscapeCardDiv.innerHTML = `<p>${gameState.currentHealth <= 0 ? 'Your journey ends in defeat.' : 'Your journey is complete!'}</p>`;
    }
}


  // --- GAME LOGIC FUNCTIONS ---
   function getCurrentSeason() {
      return seasons[gameState.currentSeasonIndex];
    }

    function advanceSeasonIfNeeded() {
      const previousSeasonIndex = gameState.currentSeasonIndex;
      gameState.currentSeasonIndex = Math.floor(gameState.turn / gameState.seasonTurnsDuration) % seasons.length;

      if (gameState.currentSeasonIndex !== previousSeasonIndex) {
          const newSeason = getCurrentSeason();
          logMessage(`The season changes to ${newSeason.name}. ${newSeason.description}`, 'info');

          // Apply/Remove Beltane max health bonus
          const oldSeason = seasons[previousSeasonIndex];
           if (newSeason.id === 'beltane') {
                gameState.maxHealth += 1;
                gameState.currentHealth += 1;
                 logMessage(`Beltane increases max health by 1!`, 'success');
           } else if (oldSeason.id === 'beltane') {
               gameState.maxHealth -= 1;
               gameState.currentHealth = Math.min(gameState.currentHealth, gameState.maxHealth);
               logMessage(`Beltane ends, max health returns to normal.`, 'info');
           }
          updateCharacterUI(); // Update UI if max health changed
          updateSeasonUI();
      }
    }

   function getChallengeDifficulty(landscape) {
        let difficulty = landscape.difficulty;
        const season = getCurrentSeason();

        // Check for 'all' modifier (Imbolc)
         if (season.modifiers.all) {
             difficulty += season.modifiers.all;
         }
         // Check for specific type modifier
         else if (season.modifiers[landscape.challengeType] !== undefined) {
             difficulty += season.modifiers[landscape.challengeType];
         }
         // Simplified resource bonus: -1 diff if you have a matching resource
         if (landscape.availableResources.some(res => gameState.resources.includes(res))) {
             // difficulty -= 1; // Let's not make it easier, just reward on success
             // console.log("Resource match bonus applied (placeholder)");
         }

        return Math.max(1, difficulty); // Min difficulty of 1
    }

   function getHealingAmount(landscape) {
        if (!landscape.healing) return 0;
        let healAmount = landscape.healing;
        const season = getCurrentSeason();
        if (season.id === 'imbolc') healAmount++;
        if (season.id === 'lughnasadh') healAmount *= 2;
        return healAmount;
    }

   function resolveLandscapeChallenge(landscape) {
        if (!gameState.character || gameState.gameOver) return;

        const difficulty = getChallengeDifficulty(landscape);
        const challengeType = landscape.challengeType;
        const roll = Math.floor(Math.random() * 10) + 1;
        let statBonus = 0;

        switch (challengeType) {
            // Simplified mapping
            case 'physical': case 'endurance': case 'agility': case 'sacrifice':
                statBonus = gameState.character.stats.physical; break;
            case 'mental': case 'perception': case 'cunning': case 'navigation': case 'knowledge': case 'wisdom':
                statBonus = gameState.character.stats.mental; break;
            case 'spiritual': case 'connection':
                statBonus = gameState.character.stats.spiritual; break;
            case 'social': case 'trade':
                statBonus = gameState.character.stats.social; break;
            default: statBonus = gameState.character.stats.mental; break;
        }

        const totalScore = roll + statBonus;
        const success = totalScore >= difficulty;

        logMessage(`Challenge: ${landscape.challenge} (${challengeType}, Diff: ${difficulty}). Roll: ${roll} + Stat ${statBonus} = ${totalScore}.`);

        if (success) {
            logMessage(`Success against ${landscape.name}!`, 'success');

            // Gain Resources
            if (landscape.availableResources && landscape.availableResources.length > 0) {
                let amountToGain = 1;
                if (getCurrentSeason().id === 'lughnasadh') amountToGain++;

                for (let i = 0; i < amountToGain; i++) {
                    if (gameState.resources.length < gameState.resourceCapacity) {
                         // Gain a random resource from the list
                        const resourceGained = landscape.availableResources[Math.floor(Math.random() * landscape.availableResources.length)];
                        gameState.resources.push(resourceGained);
                        logMessage(`Found resource: ${resourceGained}.`, 'info');
                    } else {
                        logMessage(`Resource found, but capacity full.`, 'info');
                        break;
                    }
                }
            }

            // Healing
             const healAmount = getHealingAmount(landscape);
             if (healAmount > 0) {
                 const healthBefore = gameState.currentHealth;
                 gameState.currentHealth = Math.min(gameState.maxHealth, gameState.currentHealth + healAmount);
                 const actualHeal = gameState.currentHealth - healthBefore;
                 if (actualHeal > 0) {
                     logMessage(`Healed ${actualHeal} health from ${landscape.name}.`, 'success');
                 }
             }

        } else {
            const damage = Math.max(1, difficulty - totalScore);
            gameState.currentHealth -= damage;
            logMessage(`Failed against ${landscape.name}. Took ${damage} damage.`, 'error');
            if (gameState.currentHealth <= 0) {
                gameOver(false); // Lose
            }
        }

        // Discard the active card
        if (gameState.activeLandscape) {
            gameState.discardPile.push(gameState.activeLandscape);
            gameState.activeLandscape = null;
        }

        // Update UI after resolution
        updateCharacterUI();
        updateActiveLandscapeUI(); // Clear the active card display area or show prompt
        checkWinCondition(); // Check if deck empty after resolving
    }

    function drawLandscapeCard() {
        if (gameState.gameOver || !gameState.gameStarted || gameState.activeLandscape) return; // Can't draw if game over, not started, or card active

        if (gameState.deck.length === 0) {
            logMessage("The Journey Deck is empty!", "info");
            checkWinCondition(); // Explicitly check win here
            return;
        }

        // Advance turn and check season
        gameState.turn++;
        logMessage(`--- Turn ${gameState.turn} ---`, 'info');
        advanceSeasonIfNeeded(); // Check and update season based on new turn

        // Draw card
        gameState.activeLandscape = gameState.deck.pop();
        logMessage(`Drew Landscape: ${gameState.activeLandscape.name}.`);

        // Update UI
        updateDeckUI();
        updateActiveLandscapeUI();

        // Automatically resolve the challenge
        // In a more complex game, you'd wait for player input here
        resolveLandscapeChallenge(gameState.activeLandscape);
         updateSeasonUI(); // Ensure season turn counter is updated visually
    }

    function checkWinCondition() {
        // Win if the deck is empty AND the player is not dead
        if (gameState.deck.length === 0 && gameState.currentHealth > 0 && !gameState.activeLandscape) {
            gameOver(true); // Win
        }
    }

    function gameOver(win) {
        if (gameState.gameOver) return; // Prevent multiple game over calls

        gameState.gameOver = true;
        drawCardBtn.disabled = true;
        restartBtn.style.display = 'inline-block';

        if (win) {
            logMessage("Congratulations! You have emptied the Journey Deck and survived!", 'success');
             activeLandscapeCardDiv.innerHTML = '<h2>Journey Complete!</h2><p>You faced the challenges and emerged victorious.</p>';
             activeLandscapeCardDiv.classList.add('success');
        } else {
            gameState.currentHealth = 0; // Ensure health shows 0
            logMessage("Your journey ends in defeat. Your health has reached zero.", 'error');
             activeLandscapeCardDiv.innerHTML = '<h2>Game Over</h2><p>The path proved too perilous.</p>';
              activeLandscapeCardDiv.classList.add('error');
            updateCharacterUI(); // Update health display to 0
        }
    }

   function selectCharacter(charId) {
        const selectedChar = characters.find(c => c.id === charId);
        if (!selectedChar) return;

        gameState.character = selectedChar;
        gameState.currentHealth = selectedChar.health;
        gameState.maxHealth = selectedChar.health;
        gameState.resources = [...selectedChar.startingItems];
        gameState.resourceCapacity = selectedChar.resourceCapacity;

        // --- Setup Deck ---
        gameState.deck = [...landscapes]; // Copy landscapes
        shuffleArray(gameState.deck);
        gameState.discardPile = [];
        gameState.activeLandscape = null;

        // --- Reset Other State ---
        gameState.turn = 0;
        gameState.currentSeasonIndex = Math.floor(Math.random() * seasons.length); // Start in random season
        gameState.gameOver = false;
        gameState.gameStarted = true;

        // --- Apply initial Beltane Bonus ---
         if (getCurrentSeason().id === 'beltane') {
             gameState.maxHealth += 1;
             gameState.currentHealth += 1;
         }

        // --- Update UI ---
        characterSelectionDiv.style.display = 'none';
        gameplayDiv.style.display = 'block';
        logMessagesDiv.innerHTML = ''; // Clear log
        logMessage(`Selected ${selectedChar.name}. The journey begins!`, 'info');
        logMessage(`Starting Season: ${getCurrentSeason().name}.`);

        updateCharacterUI();
        updateSeasonUI();
        updateDeckUI();
        updateActiveLandscapeUI(); // Show initial prompt

        drawCardBtn.disabled = false;
        restartBtn.style.display = 'none';
    }

  function showCharacterSelection() {
    setupDiv.style.display = 'none';
    characterSelectionDiv.style.display = 'block';
    characterSelectionDiv.innerHTML = '<h2>Choose Your Character</h2>';

    characters.forEach(char => {
      const btn = document.createElement('button');
      btn.textContent = char.name;
      const tooltipText = `
Health: ${char.health}, Capacity: ${char.resourceCapacity}
Stats: P:${char.stats.physical} M:${char.stats.mental} Sp:${char.stats.spiritual} So:${char.stats.social}
Starts with: ${char.startingItems.join(', ') || 'None'}
      `.trim();
      btn.title = tooltipText;
      btn.onclick = () => selectCharacter(char.id);
      characterSelectionDiv.appendChild(btn);
    });
  }

    function resetGame() {
        // Reset game state object
        gameState = {
            character: null, currentHealth: 0, maxHealth: 0, resources: [],
            resourceCapacity: 0, deck: [], activeLandscape: null, discardPile: [],
            currentSeasonIndex: 0, turn: 0, seasonTurnsDuration: 3,
            gameOver: false, gameStarted: false
        };

        // Reset UI elements
        setupDiv.style.display = 'block';
        characterSelectionDiv.style.display = 'none';
        gameplayDiv.style.display = 'none';
        logMessagesDiv.innerHTML = '';
        activeLandscapeCardDiv.innerHTML = '<p>Game reset. Start a new game.</p>';
         activeLandscapeCardDiv.classList.remove('active-landscape', 'success', 'error');
         resourceListUl.innerHTML = '';

        // Ensure buttons are in correct initial state
        drawCardBtn.disabled = true;
        restartBtn.style.display = 'none';
    }

  // --- Event Listeners ---
  startGameBtn.addEventListener('click', showCharacterSelection);
  drawCardBtn.addEventListener('click', drawLandscapeCard);
  restartBtn.addEventListener('click', resetGame);

  // --- Initial UI Setup ---
  setupDiv.style.display = 'block';
  characterSelectionDiv.style.display = 'none';
  gameplayDiv.style.display = 'none';
  drawCardBtn.disabled = true; // Disabled until game starts

</script>

</body>
</html>